<div class="details-modal-overlay" [class.show]="show" (click)="onCloseModal()">
  <div *ngIf="data" class="details-modal-layout" (click)="$event.stopPropagation()">
    <div class="details-modal-container" [class.single-card]="!showPaymentCard()">
      <div class="booking-info-card">
        <button class="close-btn card-close-btn" (click)="onCloseModal()" aria-label="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" />
            <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" />
          </svg>
        </button>

        <ng-container *ngIf="isResultMode()">
          <div *ngIf="isResultSuccess()" class="success-result">
            <div class="result-header">
              <div class="success-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" stroke-width="2" />
                  <polyline points="22,4 12,14.01 9,11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </div>
              <h2>การจองสำเร็จ!</h2>
              <p class="subtitle">ที่นั่งของคุณได้รับการจองเรียบร้อยแล้ว</p>
            </div>
            <div class="booking-details">
              <div class="detail-section">
                <h3>รายละเอียดการจอง</h3>
                <div class="detail-item">
                  <span class="label">หมายเลขการจอง:</span>
                  <span class="value">#{{ getModalTransactionId() }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">โซน:</span>
                  <span class="value">{{ getModalZone() }}</span>
                </div>
              </div>
              <div class="detail-section">
                <h3>ที่นั่งที่จอง</h3>
                <div class="booked-seats">
                  <div *ngFor="let seat of getModalBookedSeats(); trackBy: trackByBookedSeat" class="seat-item">
                    <div class="seat-icon">
                      <svg viewBox="0 0 24 24">
                        <rect x="4" y="4" width="16" height="10" rx="2" class="chair-back" />
                        <rect x="2" y="12" width="20" height="6" rx="3" class="chair-seat" />
                        <rect x="4" y="18" width="2" height="4" class="chair-leg" />
                        <rect x="18" y="18" width="2" height="4" class="chair-leg" />
                      </svg>
                    </div>
                    <div class="seat-info">
                      <span class="seat-number">{{ seat.row }}{{ seat.display }}</span>
                      <span class="seat-price">{{ formatPrice(seat.price) }}</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="total-section">
                <div class="total-price">
                  <span class="total-label">ราคารวมทั้งหมด</span>
                  <span class="total-amount">{{ formatPrice(getModalTotalAmount() || 0) }}</span>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="!isResultSuccess()" class="error-result">
            <div class="result-header">
              <div class="error-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" />
                  <line x1="15" y1="9" x2="9" y2="15" stroke="currentColor" stroke-width="2" />
                  <line x1="9" y1="9" x2="15" y2="15" stroke="currentColor" stroke-width="2" />
                </svg>
              </div>
              <h2>การจองไม่สำเร็จ</h2>
              <p class="subtitle">{{ getModalMessage() }}</p>
            </div>
            <div *ngIf="(getModalFailedSeats()?.length ?? 0) > 0" class="failed-seats">
              <h3>ที่นั่งที่ถูกจองไปแล้ว</h3>
              <div class="failed-list">
                <div *ngFor="let seat of getModalFailedSeats(); trackBy: trackByFailedSeat" class="failed-item">
                  <div class="failed-icon" [class]="getStatusClass(seat.status)">
                    <svg viewBox="0 0 24 24">
                      <circle cx="12" cy="7" r="3" class="person-head" />
                      <path d="M12 11c-3 0-5.5 2-6 5h12c-0.5-3-3-5-6-5z" class="person-body" />
                    </svg>
                  </div>
                  <span class="seat-number">{{ seat.row }}{{ seat.display || seat.column }}</span>
                  <span class="seat-status" [class]="getStatusClass(seat.status)">{{ getStatusText(seat.status) }}</span>
                </div>
              </div>
              <p class="retry-message">กรุณาเลือกที่นั่งใหม่และลองอีกครั้ง</p>
            </div>
          </div>
        </ng-container>

        <ng-container *ngIf="isDetailsMode()">
          <div class="booking-header">
            <div class="booking-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none" />
                <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" />
                <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" />
                <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2" />
              </svg>
            </div>
            <h3>รายละเอียดการจอง</h3>
            <span class="booking-status" [class]="getStatusClass(getModalStatus())">{{ getStatusText(getModalStatus()) }}</span>
          </div>

          <div class="booking-content">
            <div class="detail-section">
              <h4>ข้อมูลการจอง</h4>
              <div class="detail-item">
                <span class="label">หมายเลขการจอง:</span>
                <span class="value">#{{ getModalTransactionId() }}</span>
              </div>
              <div class="detail-item">
                <span class="label">จำนวนเงิน:</span>
                <span class="value">{{ formatPrice(getModalTotalAmount() || 0) }}</span>
              </div>
              <div class="detail-item">
                <span class="label">สถานะ:</span>
                <span class="value" [class]="getStatusClass(getModalStatus())">{{ getStatusText(getModalStatus()) }}</span>
              </div>
            </div>

            <div class="detail-section">
              <h4>ที่นั่งที่จอง ({{ getModalSeatsData()?.length || 0 }} ที่นั่ง)</h4>
              <div class="seats-grid">
                <div *ngFor="let seat of getModalSeatsData(); trackBy: trackByBookingSeat" class="seat-item">
                  <div class="seat-icon">
                    <svg viewBox="0 0 24 24">
                      <rect x="4" y="4" width="16" height="10" rx="2" class="chair-back" />
                      <rect x="2" y="12" width="20" height="6" rx="3" class="chair-seat" />
                      <rect x="4" y="18" width="2" height="4" class="chair-leg" />
                      <rect x="18" y="18" width="2" height="4" class="chair-leg" />
                    </svg>
                  </div>
                  <span class="seat-number">{{ seat.zone }}{{ seat.row }}{{ getDisplayNumber(seat) }}</span>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>

      <div *ngIf="showPaymentCard()" class="payment-card-container">
        <div class="payment-card">
          <button class="close-btn card-close-btn payment-close-btn" (click)="onCloseModal()" aria-label="Close">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" />
              <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" />
            </svg>
          </button>
          <div class="payment-header">
            <div class="payment-icon">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2" stroke="currentColor" stroke-width="2" />
                <line x1="1" y1="10" x2="23" y2="10" stroke="currentColor" stroke-width="2" />
              </svg>
            </div>
            <h3>ชำระเงิน</h3>
            <p class="subtitle">อัปโหลดสลิปการโอนเงิน</p>
          </div>
          <div class="payment-qr-section">
            <img src="assets/images/payment-qr.jpg" alt="Payment QR Code" class="payment-qr-image">
          </div>
          <div class="payment-content">
            <div class="transaction-item" *ngIf="getModalTransactionId() as transactionId">
              <div class="transaction-header">
                <h4>รายการจอง #{{ transactionId }}</h4>
              </div>

              <div class="upload-section">
                <div class="upload-area" [class.dragover]="dragover === transactionId" (dragover)="onDragOver($event, transactionId)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event, transactionId)" (click)="selectFile(transactionId)">
                  <div *ngIf="!getUploadedImage(transactionId)" class="upload-placeholder">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2" />
                      <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" />
                      <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2" />
                      <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2" />
                      <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2" />
                    </svg>
                    <p>คลิกหรือลากไฟล์มาวางที่นี่</p>
                    <span>รองรับ JPG, PNG, GIF (สูงสุด 16MB)</span>
                  </div>

                  <div *ngIf="getUploadedImage(transactionId)" class="uploaded-image">
                    <img [src]="getUploadedImage(transactionId)" alt="สลิปที่อัปโหลด">
                    <button class="remove-image" (click)="onRemoveUploadedImage($event, transactionId)">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" />
                        <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" />
                      </svg>
                    </button>
                  </div>

                  <div *ngIf="isUploading === transactionId" class="uploading-overlay">
                    <div class="upload-spinner"></div>
                    <p>กำลังอัปโหลด...</p>
                  </div>
                </div>
                <input type="file" [id]="'file-input-' + transactionId" accept="image/*" style="display: none" (change)="onFileSelected($event, transactionId)">
              </div>

              <div class="transaction-actions">
                <button class="cancel-btn" [disabled]="isProcessing === transactionId" (click)="onCancelTransaction(transactionId)">
                  <svg *ngIf="isProcessing !== transactionId" width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" />
                    <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" />
                  </svg>
                  <div *ngIf="isProcessing === transactionId" class="action-spinner"></div>
                  {{ isProcessing === transactionId ? 'กำลังยกเลิก...' : 'ยกเลิกการจอง' }}
                </button>

                <button class="pay-btn" [disabled]="!getUploadedImage(transactionId) || isProcessing === transactionId" (click)="onPayTransaction(transactionId)">
                  <svg *ngIf="isProcessing !== transactionId" width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <polyline points="20,6 9,17 4,12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  <div *ngIf="isProcessing === transactionId" class="action-spinner"></div>
                  {{ isProcessing === transactionId ? 'กำลังชำระ...' : 'ชำระเงิน' }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <app-confirmation
    [show]="showCancelConfirmation"
    [title]="'ยืนยันการยกเลิก'"
    [message]="'คุณต้องการยกเลิกการจองนี้หรือไม่? การดำเนินการนี้ไม่สามารถย้อนกลับได้'"
    [confirmText]="'ยกเลิกการจอง'"
    [cancelText]="'ไม่ยกเลิก'"
    [isProcessing]="isProcessing === pendingCancelTransactionId"
    (confirmed)="onCancelConfirmed()"
    (cancelled)="onCancelCancelled()"
    (closed)="onCancelCancelled()">
  </app-confirmation>
</div>